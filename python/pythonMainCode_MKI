
import serial
import time
from random import randint
import csv
import pyrebase
import json
from datetime import datetime

config={"apiKey": "AIzaSyDLEco45i2BszWHJb67eAc7qx8OZ-d9vC8",
        "authDomain": "iot-webapplication-47.firebaseapp.com",
        "databaseURL": "https://iot-webapplication-47.firebaseio.com",
        "projectId": "iot-webapplication-47",
        "storageBucket": "iot-webapplication-47.appspot.com",
        "messagingSenderId": "639567912933",
        "appId": "1:639567912933:web:e8140919d9641904e2590c"}

firebase = pyrebase.initialize_app(config)
db = firebase.database()

ser=serial.Serial('/dev/ttyUSB0',baudrate=9600,timeout=1)
time.sleep(3)

firstTimeFlag=0 #variable to avoid data streaming from happening at the first time

def stream_handler(message): #this should be put before any code
    firstTimeFlag=1
    strEvent=message["event"] # put
    strPath=message["path"] # /-K7yGTTEp7O549EzTYtI
    strData=str(message["data"]) # {'title': 'Pyrebase', "body": "etc..."}

    strPath=strPath[1:len(strPath)]#this string holds the path

    strData = strData.replace("\'", "\"")
    dict=json.loads(strData)

    # My dictionary
    for i, j in dict.items():
        command=i
        bedNum=j
    print(command)
    print(bedNum)
    if(bedNum!='-1' and firstTimeFlag!=0):
        strMsgToSend = command + '$' + bedNum + '$'
        ser.write(strMsgToSend.encode('ascii'))
        #print(strMsgToSend)

my_stream = db.child("botCONTROL").stream(stream_handler)  #enter the path name in the quotes


while 1:
   try:
      temp = ser.readline().decode('ascii')
      print(temp.strip())
      if (temp.strip() == "BED DATA"):
          ser.write('SEND DATA$'.encode('ascii'))  # request bed data from arduino
          temp = ser.readline().decode('ascii')

          strTemp = temp.split('$')  # inserts the splitted words in a list
          for i in strTemp:
              data = {'test': 'data'}
              dataToSend = 'BED NUMBER_' + i
              path = '/main/' + dataToSend + '/'
              result = db.child("main").child(dataToSend).set(data)
              print(dataToSend)
   except:
      print("EXCEPTION")
      try:
          ser=serial.Serial('/dev/ttyUSB0',baudrate=9600,timeout=1)
      except:
          print("NOT CONNECTED")




